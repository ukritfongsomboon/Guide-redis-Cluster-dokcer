user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 10000;
}

stream {
    upstream redis_cluster {
        server redis-node-1:6379 max_fails=3 fail_timeout=30s;
        server redis-node-2:6379 max_fails=3 fail_timeout=30s;
        server redis-node-3:6379 max_fails=3 fail_timeout=30s;
        server redis-node-4:6379 max_fails=3 fail_timeout=30s;
        server redis-node-5:6379 max_fails=3 fail_timeout=30s;
        server redis-node-6:6379 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 6379;
        proxy_pass redis_cluster;
        proxy_connect_timeout 1s;
        proxy_socket_keepalive on;
    }

    # Individual node mapping for testing
    upstream redis_node_1 {
        server redis-node-1:6379;
    }

    server {
        listen 7001;
        proxy_pass redis_node_1;
    }

    upstream redis_node_2 {
        server redis-node-2:6379;
    }

    server {
        listen 7002;
        proxy_pass redis_node_2;
    }

    upstream redis_node_3 {
        server redis-node-3:6379;
    }

    server {
        listen 7003;
        proxy_pass redis_node_3;
    }

    upstream redis_node_4 {
        server redis-node-4:6379;
    }

    server {
        listen 7004;
        proxy_pass redis_node_4;
    }

    upstream redis_node_5 {
        server redis-node-5:6379;
    }

    server {
        listen 7005;
        proxy_pass redis_node_5;
    }

    upstream redis_node_6 {
        server redis-node-6:6379;
    }

    server {
        listen 7006;
        proxy_pass redis_node_6;
    }
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Health check and stats
    server {
        listen 8080;

        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        location /stats {
            access_log off;
            stub_status on;
        }
    }
}
